<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>DENTAL MECHANIC SERVICE</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü¶∑</text></svg>">
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
<!-- üîù –ú–µ–Ω—é -->
<nav class="menu">
    <header><strong>ü¶∑ DENTAL MECHANIC SERVICE ü¶∑</strong></header>
    <a th:href="@{/main/dental-works/new}">NEW WORK</a>
    <a th:href="@{/main/dental-works}">WORK LIST</a>
    <a th:href="@{/main/product-map}">PRODUCT MAP</a>
    <a th:href="@{/main/user}">ACCOUNT</a>
    <a style="float:right;" th:href="@{/main/log-out}" onclick="return confirm('–í—ã–π—Ç–∏?')">
        <button>–≤—ã–π—Ç–∏</button>
    </a>
</nav>

<section style="font-size:22px;">

    <!-- PATIENT -->
    <div class="work">
        <label style="font-size:80%;">–ø–∞—Ü–∏–µ–Ω—Ç:</label><br>
        <label id="patient-label" th:text="${work.patient}">–ü–∞—Ü–∏–µ–Ω—Ç</label>
        <form id="patient-form" th:action="@{'/main/dental-works/' + ${work.id} + '/edit'}" method="post" style="display:none;">
            <input type="text" name="patient" th:value="${work.patient}" required />
            <input type="hidden" name="clinic" th:value="${work.clinic}" />
            <input type="hidden" name="status" th:value="${work.status}" />
            <input type="hidden" name="completeAt" th:value="${work.completeAt}" />
            <input type="hidden" name="comment" th:value="${work.comment}" />
            <input type="hidden" name="userId" th:value="${work.userId}" />
            <input type="submit" value="‚úÖ" style="font-weight: bold; background-color: #fffed4; height: 30px; width: 75px;"/>
            <button type="button" onclick="hideForm('patient-label', 'patient-form')">‚ùå</button>
        </form>
    </div>

    <!-- CLINIC -->
    <div class="work">
        <label style="font-size:80%;">–∫–ª–∏–Ω–∏–∫–∞:</label><br>
        <label id="clinic-label" th:text="${work.clinic}">–ö–ª–∏–Ω–∏–∫–∞</label>
        <form id="clinic-form" th:action="@{'/main/dental-works/' + ${work.id} + '/edit'}" method="post" style="display:none;">
            <input type="text" name="clinic" th:value="${work.clinic}" required />
            <input type="hidden" name="patient" th:value="${work.patient}" />
            <input type="hidden" name="status" th:value="${work.status}" />
            <input type="hidden" name="completeAt" th:value="${work.completeAt}" />
            <input type="hidden" name="comment" th:value="${work.comment}" />
            <input type="hidden" name="userId" th:value="${work.userId}" />
            <input type="submit" value="‚úÖ" style="font-weight: bold; background-color: #fffed4; height: 30px; width: 75px;"/>
            <button type="button" onclick="hideForm('clinic-label', 'clinic-form')">‚ùå</button>
        </form>
    </div>

    <!-- STATUS -->
    <div class="work">
        <label style="font-size:80%;">—Å—Ç–∞—Ç—É—Å:</label><br>
        <label id="status-label">
        <span th:switch="${work.status.name}">
            <span th:case="MAKING">–î–ï–õ–ê–ï–¢–°–Ø</span>
            <span th:case="COMPLETED">–í–´–ü–û–õ–ù–ï–ù–û</span>
            <span th:case="PAID">–û–ü–õ–ê–ß–ï–ù–û</span>
        </span>
        </label>
        <form id="status-form" th:action="@{'/main/dental-works/' + ${work.id} + '/edit'}" method="post" style="display:none;">
            <select name="status">
                <option value="MAKING">–î–ï–õ–ê–ï–¢–°–Ø</option>
                <option value="COMPLETED">–í–´–ü–û–õ–ù–ï–ù–û</option>
                <option value="PAID">–û–ü–õ–ê–ß–ï–ù–û</option>
            </select>
            <input type="hidden" name="patient" th:value="${work.patient}" />
            <input type="hidden" name="clinic" th:value="${work.clinic}" />
            <input type="hidden" name="completeAt" th:value="${work.completeAt}" />
            <input type="hidden" name="comment" th:value="${work.comment}" />
            <input type="hidden" name="userId" th:value="${work.userId}" />
            <input type="submit" value="‚úÖ" style="font-weight: bold; background-color: #fffed4; height: 30px; width: 75px;"/>
            <button type="button" onclick="hideForm('status-label', 'status-form')">‚ùå</button>
        </form>
    </div>

    <!-- COMPLETE AT -->
    <div class="work">
        <label style="font-size:80%;">–¥–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</label><br>
        <label id="completeAt-label" th:text="${work.completeAt}">01-01-2025</label>
        <form id="completeAt-form" th:action="@{'/main/dental-works/' + ${work.id} + '/edit'}" method="post" style="display:none;">
            <input type="date" name="completeAt" th:value="${work.completeAt}" required />
            <input type="hidden" name="patient" th:value="${work.patient}" />
            <input type="hidden" name="clinic" th:value="${work.clinic}" />
            <input type="hidden" name="status" th:value="${work.status}" />
            <input type="hidden" name="comment" th:value="${work.comment}" />
            <input type="hidden" name="userId" th:value="${work.userId}" />
            <input type="submit" value="‚úÖ" style="font-weight: bold; background-color: #fffed4; height: 30px; width: 75px;"/>
            <button type="button" onclick="hideForm('completeAt-label', 'completeAt-form')">‚ùå</button>
        </form>
    </div>

    <!-- PRODUCTS -->
    <div class="work" style="text-align:center; display:flex; flex-direction:column; align-items:center;">
        <label>–ü–†–û–î–£–ö–¢–´:</label><br>
        <a class="tr">
            <label id="product-label" class="td" style="cursor:pointer; width: auto;">+ –Ω–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç</label>
        </a>

        <form id="add-product" th:action="@{'/main/dental-works/' + ${work.id} + '/products/new'}" method="post" style="display:none; margin-top:10px; text-align:left; width:100%; max-width:600px;">
            <label for="product">–ø—Ä–æ–¥—É–∫—Ç:</label>
            <select id="product" name="product" required>
                <option th:each="item : ${map}"
                        th:value="${item.id}"
                        th:text="${item.title}">Product</option>
            </select>
            <label for="quantity">–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
            <input style="width:64px;" type="number" id="quantity" name="quantity" min="0" max="32" required/><br>
            <label>–¥–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</label>
            <input type="date" name="completeAt" required />
            <button type="submit" name="id" th:value="${work.id}">‚úÖ</button>
            <button type="button" onclick="hideForm('product-label', 'add-product')">‚ùå</button>
        </form><br>

        <!-- –°–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ -->
        <div th:each="product : ${work.products}" class="tr" th:id="'product-row-' + ${product.id}" style="margin-top:8px; text-align:left; width:100%; max-width:600px;">
            <div class="td">
                <b th:text="${product.title}">–ù–∞–∑–≤–∞–Ω–∏–µ</b>: <span th:text="${product.quantity}">1</span> -‚Äî-
                <small>
                    –¥–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
                    <span class="complete-label"
                          th:text="${#temporals.format(product.completeAt, 'dd-MM-yyyy')}"
                          th:attr="data-id=${product.id}, data-date=${#temporals.format(product.completeAt, 'yyyy-MM-dd')}" style="cursor:pointer; text-decoration: underline;">üóìÔ∏è</span>
                </small>

                <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è completeAt -->
                <form class="complete-form" style="display:none; margin-top: 4px;"
                      th:action="@{'/main/products/' + ${product.id} + '/complete-date'}" method="post">
                    <input type="date" name="completeAt"
                           th:value="${#temporals.format(product.completeAt, 'yyyy-MM-dd')}" required />
                    <button type="submit">‚úÖ</button>
                    <button type="button" class="cancel-complete">‚ùå</button>
                </form>
                <form th:action="@{'/main/dental-works/' + ${work.id} + '/products/delete'}" method="post">
                    <button type="submit" th:name="product" th:value="${product.id}" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç?')">—É–¥–∞–ª–∏—Ç—å</button>
                </form>
            </div>

        </div>
    </div>


    <!-- COMMENT -->
    <div class="work">
        <label style="font-size:80%;">–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label> &emsp;
        <button id="comment-label">–≤–≤–µ—Å—Ç–∏</button><br>
        <label th:text="${work.comment}">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
        <form id="comment-form" th:action="@{'/main/dental-works/' + ${work.id} + '/edit'}" method="post" style="display:none;">
            <textarea name="comment" th:text="${work.comment}"></textarea>
            <input type="hidden" name="patient" th:value="${work.patient}" />
            <input type="hidden" name="clinic" th:value="${work.clinic}" />
            <input type="hidden" name="status" th:value="${work.status}" />
            <input type="hidden" name="completeAt" th:value="${work.completeAt}" />
            <input type="hidden" name="userId" th:value="${work.userId}" />
            <input type="submit" value="‚úÖ" style="font-weight: bold; background-color: #fffed4; height: 30px; width: 75px;"/>
            <button type="button" onclick="hideForm('comment-label', 'comment-form')">‚ùå</button>
        </form>
    </div>

    <div class="work">
        <label th:text="${work.countPhoto()} + ' —Ñ–æ—Ç–æ—Ñ–∞–π–ª–æ–≤'">0 —Ñ–æ—Ç–æ—Ñ–∞–π–ª–æ–≤</label>
        <a th:href="@{/main/dental-works/' + ${work.id} + '/photo}" style="font-weight: bold; background-color: #fffed4; height: 30px; width: auto">
            –û–¢–ö–†–´–¢–¨
        </a>
    </div>

    <!-- CREATED / DELETE -->
    <div class="work">
        <label style="font-size:80%;">—Å–æ–∑–¥–∞–Ω–æ:</label><br>
        <span th:text="${#temporals.format(work.acceptedAt, 'dd-MM-yyyy')}">01-01-2000</span><br><br>

        <form th:action="@{'/main/dental-works/' + ${work.id} + '/delete'}" method="post">
            <button type="submit" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')" style="width: auto;">–£–î–ê–õ–ò–¢–¨ –ó–ê–ü–ò–°–¨</button>
        </form>
    </div>
</section>

<!-- ‚öôÔ∏è JS -->
<script>
    function toggleDateFromAttr(button) {
        const id = button.getAttribute('data-id');
        const form = document.getElementById('form-' + id);
        if (form) {
            form.style.display = (form.style.display === 'none' || form.style.display === '') ? 'block' : 'none';
        }
    }


        function hideForm(labelId, formId) {
            const label = document.getElementById(labelId);
            const form = document.getElementById(formId);
            if (label && form) {
                label.style.display = 'block';
                form.style.display = 'none';
            }
        }

        function setupToggle(labelId, formId) {
            const label = document.getElementById(labelId);
            const form = document.getElementById(formId);
            if (label && form) {
                label.addEventListener('click', () => {
                    label.style.display = 'none';
                    form.style.display = 'block';
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            setupToggle('patient-label', 'patient-form');
            setupToggle('clinic-label', 'clinic-form');
            setupToggle('status-label', 'status-form');
            setupToggle('completeAt-label', 'completeAt-form');
            setupToggle('comment-label', 'comment-form');
            setupToggle('product-label', 'add-product');
        });

    document.addEventListener('DOMContentLoaded', function () {
        // –ü–æ–∫–∞–∑ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è completeAt
        document.querySelectorAll('.complete-label').forEach(label => {
            label.addEventListener('click', () => {
                const rowId = label.getAttribute('data-id');
                const row = document.getElementById('product-row-' + rowId);
                const form = row.querySelector('.complete-form');
                const span = row.querySelector('.complete-label');

                form.style.display = 'inline-block';
                span.style.display = 'none';
            });
        });

        // –ö–Ω–æ–ø–∫–∞ "–û—Ç–º–µ–Ω–∞"
        document.querySelectorAll('.cancel-complete').forEach(button => {
            button.addEventListener('click', function () {
                const form = this.closest('.complete-form');
                const row = this.closest('.tr');
                const label = row.querySelector('.complete-label');

                form.style.display = 'none';
                label.style.display = 'inline';
            });
        });
    });
</script>
</body>
</html>
