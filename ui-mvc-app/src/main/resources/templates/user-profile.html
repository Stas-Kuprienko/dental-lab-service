<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DENTAL LAB SERVICE</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü¶∑</text></svg>">
    <link rel="stylesheet" th:href="@{/css/style.css}" />
</head>

<body>
<!-- üîù –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
<div th:replace="fragments/nav :: nav"></div>

<section style="margin:auto;">

    <h2 style="text-align:center;">–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
    <br>

    <div th:if="${message}" class="alert" th:text="${message}"></div>

    <div th:if="${error}" class="alert error" th:text="${error}"></div>

    <!-- –ò–º—è -->
    <div class="work">
        <label style="font-size:80%;">–∏–º—è:</label><br>
        <label style="font-size: 120%;" id="name-label" th:text="${user.name}">–ò–º—è</label>

        <form id="name-form" th:action="@{/main/user/update-name}" method="post" style="display: none;">
            <input type="text" name="name" th:value="${user.name}" required /><br>
            <input type="submit" value="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" class="small-button"/>
            <button type="button" onclick="hideForm('name-label', 'name-form')">‚ùå</button>
        </form>
    </div>

    <!-- Email -->
    <div class="work">
        <label style="font-size:80%;">email:</label><br>
        <label id="email-label" style="font-size: 110%;" th:text="${user.login}">user@mail.com</label>

        <div id="email-actions" style="display:none; margin-top:6px;">
            <button id="change-email-btn" type="button" class="small-button">–°–º–µ–Ω–∏—Ç—å email</button>
            <button id="no-access-btn" type="button" class="small-button">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ email?</button>
        </div>
    </div>

    <!-- –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è -->
    <div class="work">
        <button id="change-password-btn" type="button" class="small-button">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>

        <form id="password-form" th:action="@{'/main/user/change-password'}" method="post" style="display:none; margin-top:8px;">
            <label>–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å:</label><br>
            <input type="password" name="old-password" required /><br>
            <label>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:</label><br>
            <input type="password" name="new-password" required /><br>
            <label>–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:</label><br>
            <input type="password" name="confirm-password" required /><br>
            <br>
            <input class="small-button" type="submit" value="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" />
            <button type="button" id="cancel-password-btn" class="small-button">–û—Ç–º–µ–Ω–∞</button>
        </form>
    </div>

    <!-- –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω -->
    <div class="work">
        <label style="font-size:80%;">–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:</label><br>
        <span th:text="${#temporals.format(user.createdAt, 'dd-MM-yyyy')}">01-01-2024</span>
    </div>

    <!-- –£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç -->
    <div class="work">
        <form th:action="@{/main/user/delete}" method="post" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç?')">
            <button type="submit" class="medium-button">–£–î–ê–õ–ò–¢–¨ –ê–ö–ö–ê–£–ù–¢</button>
        </form>
    </div>
</section>

<!-- ‚öôÔ∏è JS -->
<script th:inline="javascript">
    const BASE_URL = [[@{/}]];
    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–∫–∞–∑–∞ / —Å–∫—Ä—ã—Ç–∏—è —Ñ–æ—Ä–º—ã
    function setupToggle(labelId, formId) {
        const label = document.getElementById(labelId);
        const form = document.getElementById(formId);
        if (label && form) {
            label.addEventListener('click', () => {
                label.style.display = 'none';
                form.style.display = 'block';
            });
        }
    }

    function hideForm(labelId, formId) {
        const label = document.getElementById(labelId);
        const form = document.getElementById(formId);
        if (label && form) {
            label.style.display = 'block';
            form.style.display = 'none';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // –ò–º—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        setupToggle('name-label', 'name-form');

        // Email ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ
        const emailLabel = document.getElementById('email-label');
        const emailActions = document.getElementById('email-actions');
        emailLabel.addEventListener('click', () => {
            emailActions.style.display = 'block';
        });

        // –¢–∞–π–º–µ—Ä –Ω–∞ 60 —Å–µ–∫—É–Ω–¥
        function startTimer(buttons) {
            buttons.forEach(btn => btn.disabled = true);
            let remaining = 60;
            const originalText = buttons[0].textContent;
            const timer = setInterval(() => {
                remaining--;
                buttons.forEach(btn => btn.textContent = `–ü–æ–¥–æ–∂–¥–∏—Ç–µ (${remaining})`);
                if (remaining <= 0) {
                    clearInterval(timer);
                    buttons.forEach(btn => {
                        btn.disabled = false;
                        btn.textContent = originalText;
                    });
                }
            }, 1000);
        }

        // –°–º–µ–Ω–∞ email
        const changeEmailBtn = document.getElementById('change-email-btn');
        const noAccessBtn = document.getElementById('no-access-btn');

        changeEmailBtn.addEventListener('click', () => {
            if (confirm('–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —Å–º–µ–Ω–∏—Ç—å email? –í–∞–º –ø—Ä–∏–¥—ë—Ç –ø–∏—Å—å–º–æ —Å–æ —Å—Å—ã–ª–∫–æ–π –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.')) {
                fetch(BASE_URL + 'main/user/change-email', { method: 'POST' });
                alert('–ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –≤–∞—à email!');
                startTimer([changeEmailBtn, noAccessBtn]);
            }
        });

        // –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ email
        noAccessBtn.addEventListener('click', () => {
            if (confirm('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–æ—á—Ç–µ? –ù–∞ –≤–∞—à Telegram –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–æ–¥.')) {
                fetch(BASE_URL + 'main/user/change-email-otp', { method: 'POST' })
                    .then(response => {
                        if (response.ok) {
                            window.location.href = BASE_URL + 'main/user/change-email-otp';
                        } else {
                            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–¥–∞!');
                        }
                    })
                    .catch(() => alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.'));
            }
        });

        // –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É
        const passwordBtn = document.getElementById('change-password-btn');
        const passwordForm = document.getElementById('password-form');
        const cancelBtn = document.getElementById('cancel-password-btn');

        passwordBtn.addEventListener('click', () => {
            passwordForm.style.display = 'block';
            passwordBtn.style.display = 'none';
        });

        cancelBtn.addEventListener('click', () => {
            passwordForm.style.display = 'none';
            passwordBtn.style.display = 'inline-block';
        });
    });
</script>

</body>
</html>
